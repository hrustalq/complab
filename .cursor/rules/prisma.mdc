---
description: Rules for Prisma and database operations
globs:
  - "src/lib/prisma.ts"
  - "src/entities/**/model/repository.ts"
  - "prisma/**/*"
---

# Prisma & Database Rules

Follow `docs/REPOSITORY.md`.

## Prisma Singleton

ALWAYS use the singleton from `src/lib/prisma.ts`:

```typescript
import prisma from '@/lib/prisma';

// ❌ NEVER: const prisma = new PrismaClient();
```

## Repository Pattern with Prisma

Create repositories in `entities/[name]/model/repository.ts`:

```typescript
import { PrismaBaseRepository } from '@/shared/repository/base-repository';
import prisma from '@/lib/prisma';
import type { Prisma } from '@/app/generated/prisma/client';
import type { Product } from './schemas';

export class ProductRepository extends PrismaBaseRepository<
  Product,
  Prisma.ProductCreateInput,
  Prisma.ProductUpdateInput
> {
  protected modelName = 'product' as const;

  async findBySlug(slug: string): Promise<Product | null> {
    const product = await prisma.product.findUnique({
      where: { slug },
      include: { category: true },
    });
    return mapPrismaProduct(product);
  }

  async findWithPagination(
    where: Prisma.ProductWhereInput,
    pagination: { page: number; limit: number }
  ) {
    const [items, total] = await Promise.all([
      prisma.product.findMany({
        where,
        skip: (pagination.page - 1) * pagination.limit,
        take: pagination.limit,
      }),
      prisma.product.count({ where }),
    ]);

    return {
      items: mapPrismaProducts(items),
      total,
      page: pagination.page,
      totalPages: Math.ceil(total / pagination.limit),
    };
  }
}

// Singleton factory (NO db argument!)
let instance: ProductRepository | null = null;

export function getProductRepository(): ProductRepository {
  if (!instance) {
    instance = new ProductRepository();
  }
  return instance;
}
```

## Type Mapping (Prisma → App)

Always map Prisma types to app schemas:

```typescript
type PrismaProduct = Prisma.ProductGetPayload<{
  include: { category: true };
}>;

function mapPrismaProduct(product: PrismaProduct | null): Product | null {
  if (!product) return null;

  return {
    id: product.id,
    name: product.name,
    price: Number(product.price),  // Decimal → number
    categorySlug: product.category?.slug ?? '',
    createdAt: product.createdAt.toISOString().split('T')[0],
    // ... other fields
  };
}
```

## Handlers with React Cache

Wrap read operations with React `cache`:

```typescript
import { cache } from 'react';
import 'server-only';
import { getProductRepository } from '../model/repository';

const productRepo = getProductRepository();

export const getProduct = cache(async (id: string) => {
  return productRepo.findById(id);
});

export const getProductBySlug = cache(async (slug: string) => {
  return productRepo.findBySlug(slug);
});
```

## Mutations with Invalidation

Mutations should invalidate cache:

```typescript
'use server';
import { revalidateTag, revalidatePath } from 'next/cache';
import { getProductRepository } from '../model/repository';

const productRepo = getProductRepository();

export async function updateProduct(id: string, data: Input) {
  const product = await productRepo.update(id, data);

  revalidateTag(`product-${id}`);
  revalidateTag(`products-${product?.categorySlug}`);
  revalidatePath('/catalog');

  return product;
}
```

## Parallel Queries

Use `Promise.all` for multiple independent queries:

```typescript
const [items, total] = await Promise.all([
  prisma.product.findMany({ where, skip, take }),
  prisma.product.count({ where }),
]);
```

## Relations in Create/Update

Use Prisma's relation syntax:

```typescript
// ✅ Correct - connecting existing relation
await prisma.orderItem.create({
  data: {
    quantity: 1,
    price: 100,
    order: { connect: { id: orderId } },
    product: { connect: { id: productId } },
  },
});

// ❌ Wrong - don't use direct IDs for relations
await prisma.orderItem.create({
  data: {
    orderId: orderId,  // ❌
    productId: productId,  // ❌
    quantity: 1,
    price: 100,
  },
});
```

## Prisma Commands

```bash
npx prisma generate    # Generate client
npx prisma migrate dev # Apply migrations
npx prisma studio      # DB viewer
npx prisma db seed     # Seed database
npm run db:seed        # Custom seed script
```
